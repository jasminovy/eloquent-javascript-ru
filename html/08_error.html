<!doctype html>
<head>
  <meta charset="utf-8">
  <title>Bugs and Error Handling :: Eloquent JavaScript</title>
  <link rel=stylesheet href="../node_modules/codemirror/lib/codemirror.css">
  <script src="../node_modules/codemirror/lib/codemirror.js"></script>
  <script src="../node_modules/codemirror/mode/javascript/javascript.js"></script>
  <script src="../node_modules/codemirror/mode/css/css.js"></script>
  <script src="../node_modules/codemirror/mode/xml/xml.js"></script>
  <script src="../node_modules/codemirror/mode/htmlmixed/htmlmixed.js"></script>
  <script src="../node_modules/codemirror/addon/edit/matchbrackets.js"></script>
  <script src="../node_modules/acorn/acorn.js"></script>
  <script src="../node_modules/acorn/util/walk.js"></script>
  <link rel=stylesheet href="ejs.css">
  <script src="js/sandbox.js"></script>
  <script src="js/ejs.js"></script>
  <script>var chapNum = 8;var sandboxLoadFiles = ["js/08_error.js"];</script>
</head>

<article>
<nav>
  <a href="07_elife.html" title="previous chapter">⬅</a>
  <a href="index.html" title="cover">⬆</a>
  <a href="09_regexp.html" title="next chapter">➡</a>
</nav>

<h1><div class=chap_num>Chapter 8</div>Bugs and Error Handling</h1>
<blockquote>
<p><a class=p_ident id="p_tsWlII94Rs" href="#p_tsWlII94Rs"></a>Debugging is twice as hard as writing the code in the first place.
Therefore, if you write the code as cleverly as possible, you are, by
definition, not smart enough to debug it.</p>
 <footer>Brian Kernighan and P.J. Plauger, <cite>The Elements of Programming Style</cite></footer>
</blockquote>
<blockquote>
<p><a class=p_ident id="p_KRfkqUrtHi" href="#p_KRfkqUrtHi"></a>Yuan-Ma had written a small program that used much global variables
and shoddy shortcuts. Reading it, a student asked ‘You warned us
against these techniques, yet I find them in your program. How can
this be?’ The master said, ‘There is no need to fetch a water hose
when the house is not on fire.’</p>
 <footer>Master Yuan-Ma, <cite>The Book of Programming</cite></footer>
</blockquote>
<p><a class=p_ident id="p_yOWLCBc/o3" href="#p_yOWLCBc/o3"></a>A program is a building of thought. Sometimes that
thought is confused. Other times, mistakes are introduced when
setting down thought in code. The result is that we end up with a
flawed program.</p>
<p><a class=p_ident id="p_+XOm2skE5P" href="#p_+XOm2skE5P"></a>Flaws in a program are usually called bugs. They are programmer
errors, or sometimes problems in other systems that the program
interacts with. Some are immediately apparent, others are subtle, and
might remain hidden in a system for years.</p>
<p><a class=p_ident id="p_lKxJJ5sgCl" href="#p_lKxJJ5sgCl"></a>It is common for problems to only surface when the program encounters
a situation that wasn&#8217;t originally considered. Sometimes, such
situations are unavoidable. When the user is asked to input their age,
and types “orange”, that is a situation that puts our program in a
difficult position, but can not be prevented by fixing a programmer
error. It has to be anticipated and handled somehow.</p>
<h2 id="_programmer_mistakes">Programmer mistakes</h2>
<p><a class=p_ident id="p_4nGvSb/+db" href="#p_4nGvSb/+db"></a>When it comes to programmer mistakes, our aim is simple. We want to
find them and fix them. Such mistakes can range from a simple typo
that causes the computer to complain as soon as it lays eyes on our
program, which is easy to notice, to a subtle mistake in our thinking
about the way the program will operate which slightly changes the
outcome of the program in very specific situations. Bugs of the latter
type can take weeks to diagnose.</p>
<p><a class=p_ident id="p_7gO99PLM0O" href="#p_7gO99PLM0O"></a>The degree in which languages help you find such mistakes varies.
Unsurprisingly, JavaScript is at the “hardly helps at all” end of that
scale. Some languages want to know, before even running a program,
what the types of all variables and expressions in the program are,
and will tell you right away when a type is used in an inconsistent
way. JavaScript only considers types when actually running the
program, and even then, it allows you to do some clearly nonsensical
things without complaint, such as <code>x = true * "monkey"</code>.</p>
<p><a class=p_ident id="p_o9bRfOflvH" href="#p_o9bRfOflvH"></a>There are some things that the language complains about, though.
Writing a program that is not syntactically valid will immediately
trigger an error. Other things, like calling something that&#8217;s not a
function or looking up a property on an undefined value, will cause an
error to be reported when the program is running and encounters the
nonsensical action.</p>
<p><a class=p_ident id="p_M/fMASXkeH" href="#p_M/fMASXkeH"></a>But often, your nonsense computation will simply
produce a <code>NaN</code> (not a number) or undefined value. And the program
happily continues, convinced that it&#8217;s doing something meaningful. The
mistake will only manifest itself later, after the bogus value
traveled though several functions, or even simply cause the program&#8217;s
output to be wrong. Finding the source of such problems can be
difficult.</p>
<p><a class=p_ident id="p_D4KIEMyl44" href="#p_D4KIEMyl44"></a>The process of finding mistakes—bugs—in programs is
called <em>debugging</em>.</p>
<h2 id="_strict_mode">Strict mode</h2>
<p><a class=p_ident id="p_Tf7P5nf0Zy" href="#p_Tf7P5nf0Zy"></a>JavaScript can be made a <em>little</em> more strict by
enabling <em>strict mode</em>. This is done by putting the string <code>"use
strict"</code> at the top of a file or a function body. Like this:</p>
<pre data-language="javascript" class="snippet cm-s-default"><a class=c_ident id="c_u7itDvZ4JZ" href="#c_u7itDvZ4JZ"></a><span class="cm-keyword">function</span> <span class="cm-variable">canYouSpotTheProblem</span>() {
  <span class="cm-string">"use strict"</span>;
  <span class="cm-keyword">for</span> (<span class="cm-variable">counter</span> <span class="cm-operator">=</span> <span class="cm-number">0</span>; <span class="cm-variable">counter</span> <span class="cm-operator">&lt;</span> <span class="cm-number">10</span>; <span class="cm-variable">counter</span><span class="cm-operator">++</span>)
    <span class="cm-variable">console</span>.<span class="cm-property">log</span>(<span class="cm-string">"Happy happy"</span>);
}

<span class="cm-variable">canYouSpotTheProblem</span>();
<span class="cm-comment">// → ReferenceError: counter is not defined</span></pre>
<p><a class=p_ident id="p_4X4yfdyK1S" href="#p_4X4yfdyK1S"></a>Normally, when you forget to put <code>var</code> in front of your variable, as
with <code>counter</code> in the example, JavaScript quietly creates a global
variable and uses that. In strict mode, however, an error is reported
instead. This is very helpful. It should be noted, though, that it
doesn&#8217;t work when the variable in question already exists as a global
variable, but only when assigning to it would have created it.</p>
<p><a class=p_ident id="p_b0vOLHiSx1" href="#p_b0vOLHiSx1"></a>Another change is that, in strict mode, the <code>this</code> binding in
functions, when they are not called as a method, holds the value
<code>undefined</code>. Normally, it holds the global scope object. This means
that if you accidentally call a method or constructor incorrectly, it
will produce an error as soon as it tries to read something from
<code>this</code>, rather than happily working with the global object, creating
and reading global variables.</p>
<pre data-language="javascript" class="snippet cm-s-default"><a class=c_ident id="c_nppvMDXEzs" href="#c_nppvMDXEzs"></a><span class="cm-keyword">function</span> <span class="cm-variable">Person</span>(<span class="cm-def">name</span>) { <span class="cm-keyword">this</span>.<span class="cm-property">name</span> <span class="cm-operator">=</span> <span class="cm-variable-2">name</span>; }
<span class="cm-comment">// Oops, forgot 'new'</span>
<span class="cm-keyword">var</span> <span class="cm-variable">ferdinand</span> <span class="cm-operator">=</span> <span class="cm-variable">Person</span>(<span class="cm-string">"Ferdinand"</span>);
<span class="cm-variable">console</span>.<span class="cm-property">log</span>(<span class="cm-variable">name</span>);
<span class="cm-comment">// → Ferdinand</span></pre>
<p><a class=p_ident id="p_NNFpkpZKdP" href="#p_NNFpkpZKdP"></a>So the bogus call to <code>Person</code> succeeded, but returned an undefined
value and created the global variable <code>name</code>. In strict mode, the
result is different.</p>
<pre data-language="javascript" class="snippet cm-s-default"><a class=c_ident id="c_PbQ5fvPb6m" href="#c_PbQ5fvPb6m"></a><span class="cm-string">"use strict"</span>;
<span class="cm-keyword">function</span> <span class="cm-variable">Person</span>(<span class="cm-def">name</span>) { <span class="cm-keyword">this</span>.<span class="cm-property">name</span> <span class="cm-operator">=</span> <span class="cm-variable-2">name</span>; }
<span class="cm-comment">// Oops, forgot 'new'</span>
<span class="cm-keyword">var</span> <span class="cm-variable">ferdinand</span> <span class="cm-operator">=</span> <span class="cm-variable">Person</span>(<span class="cm-string">"Ferdinand"</span>);
<span class="cm-comment">// → TypeError: Cannot set property 'name' of undefined</span></pre>
<p><a class=p_ident id="p_0eYPyoGi1l" href="#p_0eYPyoGi1l"></a>We are immediately told that something is wrong. This is helpful.</p>
<p><a class=p_ident id="p_qlYTT6nRD4" href="#p_qlYTT6nRD4"></a>Strict mode does a few more things. It disallows giving a function
multiple parameters with the same name, and removes some problematic
language features entirely (such as the <code>with</code> statement, which is so
misguided it is not further discussed in this book).</p>
<p><a class=p_ident id="p_kIUErMqROW" href="#p_kIUErMqROW"></a>In short, putting a <code>"use strict"</code> at the top of your program rarely
hurts, and might help you spot a problem.</p>
<h2 id="_testing">Testing</h2>
<p><a class=p_ident id="p_cfHj2WfM1O" href="#p_cfHj2WfM1O"></a>If the language is not (or hardly) going to help us find mistakes,
we&#8217;ll have to find them the hard way—by running the program and seeing
if it does the right thing.</p>
<p><a class=p_ident id="p_21E0ZgauWA" href="#p_21E0ZgauWA"></a>Doing this by hand, again and again, is a sure way to drive yourself
insane. Fortunately, it is often possible to write a second program
that automates testing your actual program.</p>
<p><a class=p_ident id="p_rx8TfcyB0X" href="#p_rx8TfcyB0X"></a>As an example, we once again use the <code>Vector</code> type.</p>
<pre data-language="javascript" class="snippet cm-s-default"><a class=c_ident id="c_mciWzOsKpc" href="#c_mciWzOsKpc"></a><span class="cm-keyword">function</span> <span class="cm-variable">Vector</span>(<span class="cm-def">x</span>, <span class="cm-def">y</span>) {
  <span class="cm-keyword">this</span>.<span class="cm-property">x</span> <span class="cm-operator">=</span> <span class="cm-variable-2">x</span>;
  <span class="cm-keyword">this</span>.<span class="cm-property">y</span> <span class="cm-operator">=</span> <span class="cm-variable-2">y</span>;
}
<span class="cm-variable">Vector</span>.<span class="cm-property">prototype</span>.<span class="cm-property">plus</span> <span class="cm-operator">=</span> <span class="cm-keyword">function</span>(<span class="cm-def">other</span>) {
  <span class="cm-keyword">return</span> <span class="cm-keyword">new</span> <span class="cm-variable">Vector</span>(<span class="cm-keyword">this</span>.<span class="cm-property">x</span> <span class="cm-operator">+</span> <span class="cm-variable-2">other</span>.<span class="cm-property">x</span>, <span class="cm-keyword">this</span>.<span class="cm-property">y</span> <span class="cm-operator">+</span> <span class="cm-variable-2">other</span>.<span class="cm-property">y</span>);
};</pre>
<p><a class=p_ident id="p_8MiHZsMF6m" href="#p_8MiHZsMF6m"></a>We will write a program to check that our implementation of <code>Vector</code>
works as indended. Then, every time we change it, we follow up by
running the test program, so that we can be reasonably confident that
we did not break anything. When we add extra functionality (for
example a new method) to the <code>Vector</code> type, we also add code that tests
the new feature to the tester.</p>
<pre data-language="javascript" class="snippet cm-s-default"><a class=c_ident id="c_vkn23Pa06p" href="#c_vkn23Pa06p"></a><span class="cm-keyword">function</span> <span class="cm-variable">testVector</span>() {
  <span class="cm-keyword">var</span> <span class="cm-def">p1</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">Vector</span>(<span class="cm-number">10</span>, <span class="cm-number">20</span>);
  <span class="cm-keyword">var</span> <span class="cm-def">p2</span> <span class="cm-operator">=</span> <span class="cm-keyword">new</span> <span class="cm-variable">Vector</span>(<span class="cm-operator">-</span><span class="cm-number">10</span>, <span class="cm-number">5</span>);
  <span class="cm-keyword">var</span> <span class="cm-def">p3</span> <span class="cm-operator">=</span> <span class="cm-variable-2">p1</span>.<span class="cm-property">plus</span>(<span class="cm-variable-2">p2</span>);

  <span class="cm-keyword">if</span> (<span class="cm-variable-2">p1</span>.<span class="cm-property">x</span> <span class="cm-operator">!==</span> <span class="cm-number">10</span>) <span class="cm-keyword">return</span> <span class="cm-string">"fail: x property"</span>;
  <span class="cm-keyword">if</span> (<span class="cm-variable-2">p1</span>.<span class="cm-property">y</span> <span class="cm-operator">!==</span> <span class="cm-number">20</span>) <span class="cm-keyword">return</span> <span class="cm-string">"fail: y property"</span>;
  <span class="cm-keyword">if</span> (<span class="cm-variable-2">p2</span>.<span class="cm-property">x</span> <span class="cm-operator">!==</span> <span class="cm-operator">-</span><span class="cm-number">10</span>) <span class="cm-keyword">return</span> <span class="cm-string">"fail: negative x property"</span>;
  <span class="cm-keyword">if</span> (<span class="cm-variable-2">p3</span>.<span class="cm-property">x</span> <span class="cm-operator">!==</span> <span class="cm-number">0</span>) <span class="cm-keyword">return</span> <span class="cm-string">"fail: x from plus"</span>;
  <span class="cm-keyword">if</span> (<span class="cm-variable-2">p3</span>.<span class="cm-property">y</span> <span class="cm-operator">!==</span> <span class="cm-number">25</span>) <span class="cm-keyword">return</span> <span class="cm-string">"fail: y from plus"</span>;
  <span class="cm-keyword">return</span> <span class="cm-string">"everything ok"</span>;
}
<span class="cm-variable">console</span>.<span class="cm-property">log</span>(<span class="cm-variable">testVector</span>());
<span class="cm-comment">// → everything ok</span></pre>
<p><a class=p_ident id="p_ugbmGkfrN+" href="#p_ugbmGkfrN+"></a>Writing tests like this tends to produce rather repetetive,
awkward code. Fortunately, there exist pieces of software that help
you build and run collections of tests (“test suites”) by providing a
language (in the form of functions and methods) more suited to
expressing them, and outputting more informative information when a
test fails. These are called <em>testing frameworks</em>.</p>
<h2 id="_debugging">Debugging</h2>
<p><a class=p_ident id="p_ZEtq3Ya+V+" href="#p_ZEtq3Ya+V+"></a>Once you notice that there is something wrong with your program,
because it misbehaves or produces errors, the next step is to figure
out <em>what</em>.</p>
<p><a class=p_ident id="p_k2xvf0xbTp" href="#p_k2xvf0xbTp"></a>Sometimes, this is obvious. The error message will point at a specific
line of your program, and if you look at the error description and
that line of code, you can often see the problem.</p>
<p><a class=p_ident id="p_U2MGlMiUv1" href="#p_U2MGlMiUv1"></a>But not always. Sometimes the line that actually triggered the problem
is not the line that caused it, but simply the first place where a
previously produced bogus value gets used in an invalid way. And
sometimes there is no error message at all, just an invalid result. If
you have been solving the exercises in the earlier chapters, you will
probably have already experienced such situations.</p>
<p><a class=p_ident id="p_4KXSsGiUBG" href="#p_4KXSsGiUBG"></a>This example program tries to convert a whole number to a string, in
any base (decimal, binary, etcetera) by repeatedly picking out the
last digit, and then dividing the number to get rid of this digit. But
the insane output that it currently produces suggests that it it has a
bug.</p>
<pre data-language="javascript" class="snippet cm-s-default"><a class=c_ident id="c_BX/QUwi5a2" href="#c_BX/QUwi5a2"></a><span class="cm-keyword">function</span> <span class="cm-variable">numberToString</span>(<span class="cm-def">n</span>, <span class="cm-def">base</span>) {
  <span class="cm-keyword">var</span> <span class="cm-def">result</span> <span class="cm-operator">=</span> <span class="cm-string">""</span>, <span class="cm-def">sign</span> <span class="cm-operator">=</span> <span class="cm-string">""</span>;
  <span class="cm-keyword">if</span> (<span class="cm-variable-2">n</span> <span class="cm-operator">&lt;</span> <span class="cm-number">0</span>) {
    <span class="cm-variable-2">sign</span> <span class="cm-operator">=</span> <span class="cm-string">"-"</span>;
    <span class="cm-variable-2">n</span> <span class="cm-operator">=</span> <span class="cm-operator">-</span><span class="cm-variable-2">n</span>;
  }
  <span class="cm-keyword">do</span> {
    <span class="cm-variable-2">result</span> <span class="cm-operator">=</span> <span class="cm-variable">String</span>(<span class="cm-variable-2">n</span> <span class="cm-operator">%</span> <span class="cm-variable-2">base</span>) <span class="cm-operator">+</span> <span class="cm-variable-2">result</span>;
    <span class="cm-variable-2">n</span> <span class="cm-operator">/=</span> <span class="cm-variable-2">base</span>;
  } <span class="cm-keyword">while</span> (<span class="cm-variable-2">n</span> <span class="cm-operator">></span> <span class="cm-number">0</span>);
  <span class="cm-keyword">return</span> <span class="cm-variable-2">sign</span> <span class="cm-operator">+</span> <span class="cm-variable-2">result</span>;
}
<span class="cm-variable">console</span>.<span class="cm-property">log</span>(<span class="cm-variable">numberToString</span>(<span class="cm-number">13</span>, <span class="cm-number">10</span>));
<span class="cm-comment">// → 1.5e-3231.3e-3221.3e-3211.3e-3201.3e-3191.3e-3181.3…</span></pre>
<p><a class=p_ident id="p_RAeAoBjrC7" href="#p_RAeAoBjrC7"></a>Even if you see the problem already, pretend for a moment that you
don&#8217;t. We know that our program is malfunctioning, and we want to find
out why.</p>
<p><a class=p_ident id="p_2OJsjnmKOW" href="#p_2OJsjnmKOW"></a>This is where you resist the urge to start making random changes to
the code for a moment and <em>think</em>. Analyze what is happening and come
up with a theory of why it might be happening. Then, make additional
observations to try and test this theory—or, if you don&#8217;t yet have a
theory, make additional observations that might help you come up with
one.</p>
<p><a class=p_ident id="p_HuAniqpAd5" href="#p_HuAniqpAd5"></a>Putting a few strategic <code>console.log</code> calls into the program is a good
way to get additional information about what the program is doing. In
this case, we want <code>n</code> to take the values <code>13</code>, <code>1</code>, and then <code>0</code>.
Let&#8217;s write out its value at the start of the loop.</p>
<pre>13
1.3
0.13
0.013
…
1.5e-323</pre>
<p><a class=p_ident id="p_I+PNN6aJ0e" href="#p_I+PNN6aJ0e"></a><em>Right</em>. Dividing 13 by 10 does not produce a whole number. What we
actually want to do is <code>n = Math.floor(n / base)</code>, so that the number
is properly “shifted” to the right.</p>
<p><a class=p_ident id="p_E0PMYRZC2c" href="#p_E0PMYRZC2c"></a>An alternative
to using <code>console.log</code> is to use the <em>debugger</em> capabilities of your
browser. Modern browsers come with the ability to set a <em>breakpoint</em>
on a specific line of your code, which will cause the execution of the
program to pause every time the line with the breakpoint is reached,
and allowing you to inspect the values of variables at that point. I
won&#8217;t go into the interface to this debugger, since it differs per
browser and browser version, but look around in the developer tools,
and search the Web. An alternative way to set a breakpoint is by
including a <code>debugger</code> statement (consisting of simply that keyword)
in your program. Whenever that is reached, if the developer tools of
the browser are active, the program will pause, and you will be able
to inspect its state.</p>
<h2 id="_unavoidable_errors">Unavoidable errors</h2>
<p><a class=p_ident id="p_KL47zNa+D/" href="#p_KL47zNa+D/"></a>Not all problems can be prevented by the programmer, unfortunately. If
your program reads any input from the outside world, or depends on
other systems in any way, there is a chance that this input is
invalid, or the other systems are broken or unreachable.</p>
<p><a class=p_ident id="p_OHKYaqbzIp" href="#p_OHKYaqbzIp"></a>Simple programs, or programs that only run under your supervision, can
afford to just give up when such a problem occurs. “Real”
applications, on the other hand, are expected to not simply crash.
Sometimes it is appropriate to take the bad input in stride and
continue running. In other cases, it is better to report to the user
what when wrong and then give up. But in either situation, the program
has to actively do something in response to the problematic situation.</p>
<h2 id="_error_propagation">Error propagation</h2>
<p><a class=p_ident id="p_aCCDOWGy88" href="#p_aCCDOWGy88"></a>Unexpected input often leads to functions not being able to do what
they are supposed to do. Say you have a function <code>promptInteger</code> that
asks the user for a whole number and returns it. What should it return
if the user inputs “orange”?</p>
<p><a class=p_ident id="p_tL4eC00B0P" href="#p_tL4eC00B0P"></a>One option is to make it return a special value. Common
choices for such values are <code>null</code> and <code>undefined</code>.</p>
<pre data-language="javascript" class="snippet cm-s-default"><a class=c_ident id="c_bwVY9M+AHx" href="#c_bwVY9M+AHx"></a><span class="cm-keyword">function</span> <span class="cm-variable">promptNumber</span>(<span class="cm-def">question</span>) {
  <span class="cm-keyword">var</span> <span class="cm-def">result</span> <span class="cm-operator">=</span> <span class="cm-variable">Number</span>(<span class="cm-variable">prompt</span>(<span class="cm-variable-2">question</span>, <span class="cm-string">""</span>));
  <span class="cm-keyword">if</span> (<span class="cm-variable">isNaN</span>(<span class="cm-variable-2">result</span>)) <span class="cm-keyword">return</span> <span class="cm-atom">null</span>;
  <span class="cm-keyword">else</span> <span class="cm-keyword">return</span> <span class="cm-variable-2">result</span>;
}

<span class="cm-variable">console</span>.<span class="cm-property">log</span>(<span class="cm-variable">promptNumber</span>(<span class="cm-string">"How many trees do you see?"</span>));</pre>
<p><a class=p_ident id="p_BQKnUyL1pY" href="#p_BQKnUyL1pY"></a>That&#8217;s a sound strategy. Now code that calls <code>promptNumber</code> must check
whether an actual number was read, and failing that, it must somehow
recover—maybe by asking again, or filling in a default value—or it, in
turn, can also return a special value to <em>its</em> caller, to indicate
that it failed to do what it was asked.</p>
<p><a class=p_ident id="p_0FyKlwlFr6" href="#p_0FyKlwlFr6"></a>In many situations, mostly when errors are likely and the caller
should be explicitly taking them into account, returning a special
value is a perfectly fine way to indicate an error. It does, however,
have its downsides. First, what if the function can already return
every possible kind of value? For such a function, it is hard to find
a special value that can be distinguished from a valid result.</p>
<p><a class=p_ident id="p_+E9fllIVBt" href="#p_+E9fllIVBt"></a>The second issue with returning special values is that it can lead to
some very cluttered code. If a piece of code calls <code>promptNumber</code> 10
times, it has to check 10 times whether <code>null</code> was returned. If
its response to finding <code>null</code> is to simply return <code>null</code> itself, and
caller will in turn have to check for it, and so on.</p>
<h2 id="_exceptions">Exceptions</h2>
<p><a class=p_ident id="p_ZBsTKhGA4i" href="#p_ZBsTKhGA4i"></a>When a
function, for any reason, cannot proceed normally, what we would
<em>like</em> to do is to just stop doing what we are doing and immediately
jump back to a place that knows how to handle the problem. That is
what <em>exception handling</em> does.</p>
<p><a class=p_ident id="p_kjXcPy8jGf" href="#p_kjXcPy8jGf"></a>Exceptions are a mechanism that works like this: it is
possible for code to <em>raise</em> (or <em>throw</em>) an exception, which is
simply a value. Raising an exception somewhat resembles a
super-charged return from a function—it does not just jump out of the
current function but also out of its callers, all the way up to the
top-level call that started the current execution. This is called
<em>unwinding the stack</em>. You may remember the stack of function
calls that was mentioned in Chapter 3. An exception zooms down this
stack, throwing away all the call contexts it encounters.</p>
<p><a class=p_ident id="p_69nuY2IK+c" href="#p_69nuY2IK+c"></a>If they always zoomed right down to the bottom of
the stack, exceptions would not be of much use. They would just
provide a novel way to blow up your program. Their power lies in the
fact that you can set “obstacles” for exceptions along the stack.
These <em>catch</em> the exception as it is zooming down and can do something
with it, after which the program continues running at the point where
the exception was caught.</p>
<p><a class=p_ident id="p_8dgVjcjpX6" href="#p_8dgVjcjpX6"></a>Here&#8217;s an example:</p>
<pre data-language="javascript" class="snippet cm-s-default"><a class=c_ident id="c_dJgNZhA1ks" href="#c_dJgNZhA1ks"></a><span class="cm-keyword">function</span> <span class="cm-variable">promptDirection</span>(<span class="cm-def">question</span>) {
  <span class="cm-keyword">var</span> <span class="cm-def">result</span> <span class="cm-operator">=</span> <span class="cm-variable">prompt</span>(<span class="cm-variable-2">question</span>, <span class="cm-string">""</span>);
  <span class="cm-keyword">if</span> (<span class="cm-variable-2">result</span>.<span class="cm-property">toLowerCase</span>() <span class="cm-operator">==</span> <span class="cm-string">"left"</span>) <span class="cm-keyword">return</span> <span class="cm-string">"L"</span>;
  <span class="cm-keyword">if</span> (<span class="cm-variable-2">result</span>.<span class="cm-property">toLowerCase</span>() <span class="cm-operator">==</span> <span class="cm-string">"right"</span>) <span class="cm-keyword">return</span> <span class="cm-string">"R"</span>;
  <span class="cm-keyword">throw</span> <span class="cm-keyword">new</span> <span class="cm-variable">Error</span>(<span class="cm-string">"Invalid direction: "</span> <span class="cm-operator">+</span> <span class="cm-variable-2">result</span>);
}

<span class="cm-keyword">function</span> <span class="cm-variable">look</span>() {
  <span class="cm-keyword">if</span> (<span class="cm-variable">promptDirection</span>(<span class="cm-string">"Which way?"</span>) <span class="cm-operator">==</span> <span class="cm-string">"L"</span>)
    <span class="cm-keyword">return</span> <span class="cm-string">"a house"</span>;
  <span class="cm-keyword">else</span>
    <span class="cm-keyword">return</span> <span class="cm-string">"two angry bears"</span>;
}

<span class="cm-keyword">try</span> {
  <span class="cm-variable">console</span>.<span class="cm-property">log</span>(<span class="cm-string">"You see"</span>, <span class="cm-variable">look</span>());
} <span class="cm-keyword">catch</span> (<span class="cm-def">error</span>) {
  <span class="cm-variable">console</span>.<span class="cm-property">log</span>(<span class="cm-string">"Something went wrong: "</span> <span class="cm-operator">+</span> <span class="cm-variable-2">error</span>);
}</pre>
<p><a class=p_ident id="p_nA0vtBKVjy" href="#p_nA0vtBKVjy"></a>The <code>throw</code>
keyword is used to raise an exception. Catching one is done by
wrapping a piece of code in a <code>try</code> block, followed by the keyword
<code>catch</code>. When this body (the first <code>console.log</code> call in the example)
causes an exception, the second block is evaluated. The variable name
(in parentheses) after <code>catch</code> will be bound to the exception value.
After the <code>catch</code> block finishes (or when the <code>try</code> block finishes
without problems) control proceeds below the statement as usual.</p>
<p><a class=p_ident id="p_0m/weWGs2g" href="#p_0m/weWGs2g"></a>In this case, we used the <code>Error</code> constructor to
create our exception value. This is a standard JavaScript constructor
that creates an object with a <code>message</code> property. In modern JavaScript
environments, instances of this constructor also gather information,
in their <code>stack</code> property, on call stack that existed when the
exception was created. This can be very helpful when trying to debug a
problem, as it tells us precisely in which function the problem
occurred, and which other functions led up to the call that failed.</p>
<p><a class=p_ident id="p_BYCPINQ0h5" href="#p_BYCPINQ0h5"></a>Note that the function <code>look</code> completely ignores the possibility that
<code>promptDirection</code> might go wrong. This is the big advantage of
exceptions—error-handling code is necessary only at the point where
the error occurs and at the point where it is handled. The functions
in between can forget all about it.</p>
<p><a class=p_ident id="p_deFX/IC34y" href="#p_deFX/IC34y"></a>Well, almost...</p>
<h2 id="_cleaning_up_after_exceptions">Cleaning up after exceptions</h2>
<p><a class=p_ident id="p_qnJkou8oDN" href="#p_qnJkou8oDN"></a>Consider the following situation: a function
<code>withContext</code>, wants to make sure that, during its execution, the
top-level variable <code>context</code> holds a specific context value. After it
finishes, it restores this variable to its old value.</p>
<pre data-language="javascript" class="snippet cm-s-default"><a class=c_ident id="c_FkbwqXEJ6U" href="#c_FkbwqXEJ6U"></a><span class="cm-keyword">var</span> <span class="cm-variable">context</span> <span class="cm-operator">=</span> <span class="cm-atom">null</span>;

<span class="cm-keyword">function</span> <span class="cm-variable">withContext</span>(<span class="cm-def">newContext</span>, <span class="cm-def">body</span>) {
  <span class="cm-keyword">var</span> <span class="cm-def">oldContext</span> <span class="cm-operator">=</span> <span class="cm-variable">context</span>;
  <span class="cm-variable">context</span> <span class="cm-operator">=</span> <span class="cm-variable-2">newContext</span>;
  <span class="cm-keyword">var</span> <span class="cm-def">result</span> <span class="cm-operator">=</span> <span class="cm-variable-2">body</span>();
  <span class="cm-variable">context</span> <span class="cm-operator">=</span> <span class="cm-variable-2">oldContext</span>;
  <span class="cm-keyword">return</span> <span class="cm-variable-2">result</span>;
}</pre>
<p><a class=p_ident id="p_695isCQEpS" href="#p_695isCQEpS"></a>What if <code>body</code> raises an exception? In that case, the call to
<code>withContext</code> will be thrown off the stack by the exception, and
<code>context</code> will never be set back to its old value.</p>
<p><a class=p_ident id="p_tSD0hfdZ/H" href="#p_tSD0hfdZ/H"></a>There is one more feature that
<code>try</code> statements have. They may be followed by a <code>finally</code> block
(instead of, or in addition to, the <code>catch</code> block). This means “no
matter <em>what</em> happens, run this code after trying to run the code in
the <code>try</code> block”. If a function has to clean something up, the cleanup
code should usually be put into a <code>finally</code> block:</p>
<pre data-language="javascript" class="snippet cm-s-default"><a class=c_ident id="c_1Nrg8ROQ4a" href="#c_1Nrg8ROQ4a"></a><span class="cm-keyword">function</span> <span class="cm-variable">withContext</span>(<span class="cm-def">newContext</span>, <span class="cm-def">body</span>) {
  <span class="cm-keyword">var</span> <span class="cm-def">oldContext</span> <span class="cm-operator">=</span> <span class="cm-variable">context</span>;
  <span class="cm-variable">context</span> <span class="cm-operator">=</span> <span class="cm-variable-2">newContext</span>;
  <span class="cm-keyword">try</span> {
    <span class="cm-keyword">return</span> <span class="cm-variable-2">body</span>();
  } <span class="cm-keyword">finally</span> {
    <span class="cm-variable">context</span> <span class="cm-operator">=</span> <span class="cm-variable-2">oldContext</span>;
  }
}</pre>
<p><a class=p_ident id="p_exXm7BGc3g" href="#p_exXm7BGc3g"></a>Note that we no longer have to store the result of <code>body</code> (which we
want to return) in a variable. Even if we return directly from the
<code>try</code> block, the <code>finally</code> block will be run. Now we can do this, and
be safe:</p>
<pre data-language="javascript" class="snippet cm-s-default"><a class=c_ident id="c_E7PU7n73Qo" href="#c_E7PU7n73Qo"></a><span class="cm-keyword">try</span> {
  <span class="cm-variable">withContext</span>(<span class="cm-number">5</span>, <span class="cm-keyword">function</span>() {
    <span class="cm-keyword">if</span> (<span class="cm-variable">context</span> <span class="cm-operator">&lt;</span> <span class="cm-number">10</span>)
      <span class="cm-keyword">throw</span> <span class="cm-keyword">new</span> <span class="cm-variable">Error</span>(<span class="cm-string">"Not enough context!"</span>);
  });
} <span class="cm-keyword">catch</span> (<span class="cm-def">e</span>) {
  <span class="cm-variable">console</span>.<span class="cm-property">log</span>(<span class="cm-string">"Ignoring: "</span> <span class="cm-operator">+</span> <span class="cm-variable-2">e</span>);
}

<span class="cm-variable">console</span>.<span class="cm-property">log</span>(<span class="cm-variable">context</span>);
<span class="cm-comment">// → null</span></pre>
<h2 id="_unhandled_exceptions">Unhandled exceptions</h2>
<p><a class=p_ident id="p_SEIW7+F+AD" href="#p_SEIW7+F+AD"></a>When an exception
makes it all the way to the bottom of the stack without being caught,
it gets handled by the environment. What this means differs between
environments. In browsers, a description of the error is typically
written to the JavaScript console (reachable in the menus, somewhere
under “tools” or “developer”).</p>
<p><a class=p_ident id="p_9JOlpepKZE" href="#p_9JOlpepKZE"></a>For programmer mistakes or problems that the program cannot possibly
handle, just letting the error go through is often okay. An unhandled
exception is a reasonable way to signal a broken program, and the
JavaScript console will, on modern browsers, provide you with some
information about which function calls were on the stack when the
problem occurred.</p>
<p><a class=p_ident id="p_6cLdy7IIUS" href="#p_6cLdy7IIUS"></a>For problems that are <em>expected</em> to happen during routine use,
crashing with an unhandled exception is obviously not a very friendly
response.</p>
<h2 id="_selective_catching">Selective catching</h2>
<p><a class=p_ident id="p_/EpxGjvW2p" href="#p_/EpxGjvW2p"></a>Language-use mistakes, like referencing a nonexistent variable,
looking up a property on <code>null</code>, or calling something that&#8217;s not a
function, will also result in exceptions being raised. These can be
caught just like your own exceptions.</p>
<p><a class=p_ident id="p_hqHJot1Va+" href="#p_hqHJot1Va+"></a>When a <code>catch</code> body is entered, all we know is that
<em>something</em> in our <code>try</code> body caused an exception. What we don&#8217;t know
is <em>what</em> did, and <em>which</em> exception it caused.</p>
<p><a class=p_ident id="p_IJP3SSaNYC" href="#p_IJP3SSaNYC"></a>JavaScript doesn&#8217;t provide direct support for selectively catching
exceptions (which is a rather glaring omission)... you can catch them
all, or you don&#8217;t catch any. This makes it very easy, accidentally or
out of laziness, to <em>assume</em> that the exception you get is the one you
happened to be thinking about when you wrote the <code>catch</code> block.</p>
<p><a class=p_ident id="p_O9bj9nd33p" href="#p_O9bj9nd33p"></a>But it might not be. Some other assumption might be violated, or you
might have introduced a bug somewhere that is causing an exception.
Here is an example, which <em>tries</em> to keep on calling <code>promptDirection</code>
until it gets a valid answer.</p>
<pre data-language="javascript" class="snippet cm-s-default"><a class=c_ident id="c_W3CuGyc2mc" href="#c_W3CuGyc2mc"></a><span class="cm-keyword">for</span> (;;) {
  <span class="cm-keyword">try</span> {
    <span class="cm-keyword">var</span> <span class="cm-variable">dir</span> <span class="cm-operator">=</span> <span class="cm-variable">promtDirection</span>(<span class="cm-string">"Where?"</span>); <span class="cm-comment">// ← typo!</span>
    <span class="cm-variable">console</span>.<span class="cm-property">log</span>(<span class="cm-string">"You chose "</span>, <span class="cm-variable">dir</span>);
    <span class="cm-keyword">break</span>;
  } <span class="cm-keyword">catch</span> (<span class="cm-def">e</span>) {
    <span class="cm-variable">console</span>.<span class="cm-property">log</span>(<span class="cm-string">"Not a valid direction. Try again."</span>);
  }
}</pre>
<p><a class=p_ident id="p_UMh66pw2z8" href="#p_UMh66pw2z8"></a> The <code>for (;;)</code> construct is a way to
intentionally create a loop that doesn&#8217;t terminate on its own. We only
break out of the loop when a valid direction is given. <em>But</em>, we
misspelled <code>promptDirection</code>, which will result in an “undefined
variable” error. Because the <code>catch</code> block completely ignores its
exception value (<code>e</code>), going ahead and assuming it knows what the
problem is, it&#8217;ll wrongly treat the variable error as if it is bad
input. Not only does this cause an infinite loop, it also “buries” the
(very useful) error message about the misspelled variable.</p>
<p><a class=p_ident id="p_hk/lwBIhah" href="#p_hk/lwBIhah"></a>As a general rule, don&#8217;t blanket-catch exceptions unless it is for the
purpose of “routing” them somewhere else (for example, sending them
over the network). And even then, think carefully about how you might
be hiding information.</p>
<p><a class=p_ident id="p_FVrgLfvNOk" href="#p_FVrgLfvNOk"></a>So we want to catch a <em>specific</em> kind of exception. We can do this by,
in the <code>catch</code> block, checking whether the exception we got is the one
we are interested in, and re-throwing it otherwise. But how do we
recognize an exception?</p>
<p><a class=p_ident id="p_YsRupuAqlm" href="#p_YsRupuAqlm"></a>Of course, we could match its <code>message</code> property against the error
message we happen to expect in the exception we are interested in. But
that&#8217;s a shaky way to program—we&#8217;re using information that&#8217;s intended
for human consumption (the message) to make decisions. As soon as
someone changes (or translates) the message, the code stops working.</p>
<p><a class=p_ident id="p_hkSxiLPsMn" href="#p_hkSxiLPsMn"></a>Rather, let us define a new type of error, and use <code>instanceof</code> to
identify it.</p>
<pre data-language="javascript" class="snippet cm-s-default"><a class=c_ident id="c_ZtibWk6KwK" href="#c_ZtibWk6KwK"></a><span class="cm-keyword">function</span> <span class="cm-variable">InputError</span>(<span class="cm-def">message</span>) {
  <span class="cm-keyword">this</span>.<span class="cm-property">message</span> <span class="cm-operator">=</span> <span class="cm-variable-2">message</span>;
  <span class="cm-keyword">this</span>.<span class="cm-property">stack</span> <span class="cm-operator">=</span> (<span class="cm-keyword">new</span> <span class="cm-variable">Error</span>()).<span class="cm-property">stack</span>;
}
<span class="cm-variable">InputError</span>.<span class="cm-property">prototype</span> <span class="cm-operator">=</span> <span class="cm-variable">Object</span>.<span class="cm-property">create</span>(<span class="cm-variable">Error</span>.<span class="cm-property">prototype</span>);
<span class="cm-variable">InputError</span>.<span class="cm-property">prototype</span>.<span class="cm-property">name</span> <span class="cm-operator">=</span> <span class="cm-string">"InputError"</span>;</pre>
<p><a class=p_ident id="p_ckH3IH2NQq" href="#p_ckH3IH2NQq"></a>The prototype is made to derive of <code>Error.prototype</code>, so that
<code>instanceof Error</code> will also return true for such objects. It&#8217;s also
given a <code>name</code> property, since the standard error types (<code>Error</code>,
<code>SyntaxError</code>, <code>ReferenceError</code>, and so on) also have such a property.</p>
<p><a class=p_ident id="p_r3uKHa4jV1" href="#p_r3uKHa4jV1"></a>The assignment to the <code>stack</code> property tries to give this object a
somewhat useful stack trace, on platforms that support it, by creating
an error object and using that object&#8217;s <code>stack</code> property.</p>
<p><a class=p_ident id="p_3NvX0v0g0n" href="#p_3NvX0v0g0n"></a>Now <code>promptDirection</code> can throw such an error.</p>
<pre data-language="javascript" class="snippet cm-s-default"><a class=c_ident id="c_sIDbifSyff" href="#c_sIDbifSyff"></a><span class="cm-keyword">function</span> <span class="cm-variable">promptDirection</span>(<span class="cm-def">question</span>) {
  <span class="cm-keyword">var</span> <span class="cm-def">result</span> <span class="cm-operator">=</span> <span class="cm-variable">prompt</span>(<span class="cm-variable-2">question</span>, <span class="cm-string">""</span>);
  <span class="cm-keyword">if</span> (<span class="cm-variable-2">result</span>.<span class="cm-property">toLowerCase</span>() <span class="cm-operator">==</span> <span class="cm-string">"left"</span>) <span class="cm-keyword">return</span> <span class="cm-string">"L"</span>;
  <span class="cm-keyword">if</span> (<span class="cm-variable-2">result</span>.<span class="cm-property">toLowerCase</span>() <span class="cm-operator">==</span> <span class="cm-string">"right"</span>) <span class="cm-keyword">return</span> <span class="cm-string">"R"</span>;
  <span class="cm-keyword">throw</span> <span class="cm-keyword">new</span> <span class="cm-variable">InputError</span>(<span class="cm-string">"Invalid direction: "</span> <span class="cm-operator">+</span> <span class="cm-variable-2">result</span>);
}</pre>
<p><a class=p_ident id="p_dtouAk0YL3" href="#p_dtouAk0YL3"></a>And the loop can catch it more carefully.</p>
<pre data-language="javascript" class="snippet cm-s-default"><a class=c_ident id="c_tTVsZNAA73" href="#c_tTVsZNAA73"></a><span class="cm-keyword">for</span> (;;) {
  <span class="cm-keyword">try</span> {
    <span class="cm-keyword">var</span> <span class="cm-variable">dir</span> <span class="cm-operator">=</span> <span class="cm-variable">promptDirection</span>(<span class="cm-string">"Where?"</span>);
    <span class="cm-variable">console</span>.<span class="cm-property">log</span>(<span class="cm-string">"You chose "</span>, <span class="cm-variable">dir</span>);
    <span class="cm-keyword">break</span>;
  } <span class="cm-keyword">catch</span> (<span class="cm-def">e</span>) {
    <span class="cm-keyword">if</span> (<span class="cm-variable-2">e</span> <span class="cm-keyword">instanceof</span> <span class="cm-variable">InputError</span>)
      <span class="cm-variable">console</span>.<span class="cm-property">log</span>(<span class="cm-string">"Not a valid direction. Try again."</span>);
    <span class="cm-keyword">else</span>
      <span class="cm-keyword">throw</span> <span class="cm-variable-2">e</span>;
  }
}</pre>
<p><a class=p_ident id="p_7AsWCl9PWW" href="#p_7AsWCl9PWW"></a>This will only catch instances of <code>InputError</code> and let unrelated
exceptions through. If you reintroduce the typo, that error will be
properly reported.</p>
<p><a class=p_ident id="p_un+x/vf0Z3" href="#p_un+x/vf0Z3"></a>In some cases, where you only need one instance of your error (it
always has the same message) and stack traces are not important, you
can simplify things a little by simply defining a single error object,
not a constructor, and comparing exceptions to it with the “==”
operator.</p>
<h2 id="_assertions">Assertions</h2>
<p><a class=p_ident id="p_pnjWh6SI2+" href="#p_pnjWh6SI2+"></a>Exceptions give us another tool for doing basic sanity checking for
programmer errors. Consider this helper function, <code>assert</code>:</p>
<pre data-language="javascript" class="snippet cm-s-default"><a class=c_ident id="c_5oaHu0DYVz" href="#c_5oaHu0DYVz"></a><span class="cm-keyword">function</span> <span class="cm-variable">AssertionFailed</span>(<span class="cm-def">message</span>) {
  <span class="cm-keyword">this</span>.<span class="cm-property">message</span> <span class="cm-operator">=</span> <span class="cm-variable-2">message</span>;
}
<span class="cm-variable">AssertionFailed</span>.<span class="cm-property">prototype</span> <span class="cm-operator">=</span> <span class="cm-variable">Object</span>.<span class="cm-property">create</span>(<span class="cm-variable">Error</span>.<span class="cm-property">prototype</span>);

<span class="cm-keyword">function</span> <span class="cm-variable">assert</span>(<span class="cm-def">test</span>, <span class="cm-def">message</span>) {
  <span class="cm-keyword">if</span> (<span class="cm-operator">!</span><span class="cm-variable-2">test</span>) <span class="cm-keyword">throw</span> <span class="cm-keyword">new</span> <span class="cm-variable">AssertionFailed</span>(<span class="cm-variable-2">message</span>);
}

<span class="cm-keyword">function</span> <span class="cm-variable">lastElement</span>(<span class="cm-def">array</span>) {
  <span class="cm-variable">assert</span>(<span class="cm-variable-2">array</span>.<span class="cm-property">length</span> <span class="cm-operator">></span> <span class="cm-number">0</span>, <span class="cm-string">"empty array in lastElement"</span>);
  <span class="cm-keyword">return</span> <span class="cm-variable-2">array</span>[<span class="cm-variable-2">array</span>.<span class="cm-property">length</span> <span class="cm-operator">-</span> <span class="cm-number">1</span>];
}</pre>
<p><a class=p_ident id="p_BAB00/Xbt9" href="#p_BAB00/Xbt9"></a>This provides a relatively compact way to enforce expected conditions,
and helpfully blow up the program immediately when they do not hold.
The <code>lastElement</code> function, which simply fetches the last element from
an array, would return <code>undefined</code> on empty arrays when written in the
simple way. Fetching the last element from an empty array does not
make much sense, so it is almost certainly a programmer error when we
do it.</p>
<p><a class=p_ident id="p_wmVVstENIA" href="#p_wmVVstENIA"></a>Assertions are a way to make sure mistakes cause failures at the point
of the mistake, rather than silently producing nonsense values that
may go on to cause trouble in an unrelated part of the system.</p>
<h2 id="_summary">Summary</h2>
<p><a class=p_ident id="p_rD8/ab0/w4" href="#p_rD8/ab0/w4"></a>Mistakes and bad input are a fact of life. Bugs in programs need to be
found and fixed. They can be made easier to notice by having automated
test suites and adding assertions to your programs.</p>
<p><a class=p_ident id="p_6/bb/yZogT" href="#p_6/bb/yZogT"></a>Problems caused by factors outside of the system should also, usually,
be handled gracefully. Sometimes, when the problem can be handled
locally, special return values are a sane way to track them.
Otherwise, exceptions are preferable.</p>
<p><a class=p_ident id="p_ZJkq9NFh8W" href="#p_ZJkq9NFh8W"></a>Throwing an exception causes the call stack to be unwound until the
next enclosing <code>try</code>/<code>catch</code> block, or until the bottom of the stack.
The exception value will be given to the <code>catch</code> block that catches it,
which should verify that it is actually the kind of exception it is
trying to handle, and then do something with it. To deal with the
unpredictable control flow caused by exceptions (implicit jumps out of
functions), <code>finally</code> blocks can be used to ensure some piece of code
is <em>always</em> run when a block finishes.</p>
<h2 id="_exercises">Exercises</h2>
<h3 id="_retry">Retry</h3>
<p><a class=p_ident id="p_wgMd6cakmm" href="#p_wgMd6cakmm"></a>If you had a function <code>primitiveMultiply</code>, that, in 50% of cases, multiplied
two numbers, and in the other 50% raised an exception of type
<code>MultiplicatorUnitFailure</code>, could you write a function that wraps this
clunky function and just keeps trying until a call succeeds, returning
the result?</p>
<p><a class=p_ident id="p_fTfzvQ+fqD" href="#p_fTfzvQ+fqD"></a>Make sure that you only handle the exceptions you are trying to
handle.</p>
<pre data-language="javascript" class="snippet cm-s-default"><a class=c_ident id="c_XXZm1Wx8q3" href="#c_XXZm1Wx8q3"></a><span class="cm-keyword">function</span> <span class="cm-variable">MultiplicatorUnitFailure</span>() {}

<span class="cm-keyword">function</span> <span class="cm-variable">primitiveMultiply</span>(<span class="cm-def">a</span>, <span class="cm-def">b</span>) {
  <span class="cm-keyword">if</span> (<span class="cm-variable">Math</span>.<span class="cm-property">random</span>() <span class="cm-operator">&lt;</span> <span class="cm-number">0.5</span>)
    <span class="cm-keyword">return</span> <span class="cm-variable-2">a</span> <span class="cm-operator">*</span> <span class="cm-variable-2">b</span>;
  <span class="cm-keyword">else</span>
    <span class="cm-keyword">throw</span> <span class="cm-keyword">new</span> <span class="cm-variable">MultiplicatorUnitFailure</span>();
}

<span class="cm-keyword">function</span> <span class="cm-variable">reliableMultiply</span>(<span class="cm-def">a</span>, <span class="cm-def">b</span>) {
  <span class="cm-comment">// Your code here.</span>
}

<span class="cm-variable">console</span>.<span class="cm-property">log</span>(<span class="cm-variable">reliableMultiply</span>(<span class="cm-number">8</span>, <span class="cm-number">8</span>));
<span class="cm-comment">// → 64</span></pre>
<div class=solution><div class=solution-text>
<p><a class=p_ident id="p_ChowJFeR1F" href="#p_ChowJFeR1F"></a>The call to <code>primitiveMultiply</code> should obviously happen in a <code>try</code>
block. The corresponding <code>catch</code> block should re-throw the exception
when it is not an instance of <code>MultiplicatorUnitFailure</code>, and ensure
the call is retried when it is.</p>
<p><a class=p_ident id="p_c2MPH2Cr0C" href="#p_c2MPH2Cr0C"></a>To do the retrying, you can either use a loop that you only break (or
return) out of when a call succeeds, as in the <code>look</code> example earlier
in this chapter, or use recursion (and hope you don&#8217;t get a string of
failures so long that it overflows the stack—which is a pretty safe
bet).</p>
</div></div>
<h3 id="_the_locked_box">The locked box</h3>
<p><a class=p_ident id="p_uGznOGuYh8" href="#p_uGznOGuYh8"></a>Consider the following rather contrived object:</p>
<pre data-language="javascript" class="snippet cm-s-default"><a class=c_ident id="c_T6SjLRzJPl" href="#c_T6SjLRzJPl"></a><span class="cm-keyword">var</span> <span class="cm-variable">box</span> <span class="cm-operator">=</span> {
  <span class="cm-property">locked</span>: <span class="cm-atom">true</span>,
  <span class="cm-property">unlock</span>: <span class="cm-keyword">function</span>() { <span class="cm-keyword">this</span>.<span class="cm-property">locked</span> <span class="cm-operator">=</span> <span class="cm-atom">false</span>; },
  <span class="cm-property">lock</span>: <span class="cm-keyword">function</span>() { <span class="cm-keyword">this</span>.<span class="cm-property">locked</span> <span class="cm-operator">=</span> <span class="cm-atom">true</span>;  },
  <span class="cm-property">_content</span>: [],
  <span class="cm-property">get</span> <span class="cm-property">content</span>() {
    <span class="cm-keyword">if</span> (<span class="cm-keyword">this</span>.<span class="cm-property">locked</span>) <span class="cm-keyword">throw</span> <span class="cm-keyword">new</span> <span class="cm-variable">Error</span>(<span class="cm-string">"Locked!"</span>);
    <span class="cm-keyword">return</span> <span class="cm-keyword">this</span>.<span class="cm-property">_content</span>;
  }
};</pre>
<p><a class=p_ident id="p_Jk8cP96rqW" href="#p_Jk8cP96rqW"></a>It is a box, with a lock. Its content is an array, but you can only
get at it (the <code>_content</code> property is off limits) when the box is
unlocked.</p>
<p><a class=p_ident id="p_KI+tJ+amDX" href="#p_KI+tJ+amDX"></a>Write a function <code>withBoxUnlocked</code> that takes a function value as
argument, unlocks the box, runs the function, and then ensures that
the box is locked again, regardless of whether that function returned
normally or threw an exception.</p>
<pre data-language="javascript" class="snippet cm-s-default"><a class=c_ident id="c_VUwlz9FbZt" href="#c_VUwlz9FbZt"></a><span class="cm-keyword">function</span> <span class="cm-variable">withBoxUnlocked</span>(<span class="cm-def">body</span>) {
  <span class="cm-comment">// Your code here.</span>
}

<span class="cm-variable">withBoxUnlocked</span>(<span class="cm-keyword">function</span>() {
  <span class="cm-variable">box</span>.<span class="cm-property">content</span>.<span class="cm-property">push</span>(<span class="cm-string">"gold piece"</span>);
});

<span class="cm-variable">withBoxUnlocked</span>(<span class="cm-keyword">function</span>() {
  <span class="cm-keyword">throw</span> <span class="cm-keyword">new</span> <span class="cm-variable">Error</span>(<span class="cm-string">"Pirates on the horizon! Abort!"</span>);
});
<span class="cm-variable">console</span>.<span class="cm-property">log</span>(<span class="cm-variable">box</span>.<span class="cm-property">locked</span>);
<span class="cm-comment">// → true</span></pre>
<p><a class=p_ident id="p_PUucjaf/5N" href="#p_PUucjaf/5N"></a>For extra points, make sure that if you call <code>withBoxUnlocked</code> when
the box is already unlocked, the box simply stays unlocked.</p>
<div class=solution><div class=solution-text>
<p><a class=p_ident id="p_4MxgD1VcbV" href="#p_4MxgD1VcbV"></a>This exercise calls for a <code>finally</code> form, as you probably guessed.
Your function first unlocks the box, and then calls the argument
function from inside a <code>try</code> body. The <code>finally</code> block after it locks
the box again.</p>
<p><a class=p_ident id="p_PvZL0oQnMG" href="#p_PvZL0oQnMG"></a>To make sure we don&#8217;t lock the box when it wasn&#8217;t already locked,
check its lock at the start of the function, and only unlock and lock
it when it started out locked.</p>
</div></div>
<nav>
  <a href="07_elife.html" title="previous chapter">⬅</a>
  <a href="index.html" title="cover">⬆</a>
  <a href="09_regexp.html" title="next chapter">➡</a>
</nav>
</article>
